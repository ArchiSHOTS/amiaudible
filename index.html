<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Am I Audible – Voice Confidence Checker</title>
    <!-- Open Graph Meta Tags for Social Sharing -->
    <meta property="og:title" content="Am I Audible - Voice Confidence Checker">
    <meta property="og:description" content="Discover your voice superpowers! Analyze and improve your clarity with our fun beta tool.">
    <meta property="og:image" content="/thumbnail.png">
    <meta property="og:url" content="https://amiaudible.com">
    <meta property="og:type" content="website">
    <link rel="icon" href="/favicon.svg" type="image/svg+xml">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Poppins:wght@700&display=swap" rel="stylesheet">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <style>
    :root {
            --accent1: #AA6CFF;
            --accent2: #FC67FA;
            --accent3: #8f6ff7;
            --accent4: #f7c1ff;
            --bg-dark: #240148;
            --bg-mid: #40159f;
            --bg-light: #9345ff;
            --button-grad: linear-gradient(90deg, var(--accent1), var(--accent2));
            --metric-grad: linear-gradient(90deg, var(--accent3), var(--accent2));
            --card-bg: rgba(44, 3, 70, 0.97);
        }
        html, body {
            margin: 0;
            padding: 0;
            min-height: 100vh;
            font-family: 'Inter', sans-serif;
            background: linear-gradient(120deg, #300050 30%, #FF6FD8 100%);
            color: #fff;
            overflow-x: hidden;
        }
        .waves-bg {
            position: fixed;
            left: 0; top: 0; width: 100vw; height: 100vh;
            z-index: 0;
            overflow: hidden;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 18px;
            position: relative;
            z-index: 1;
        }
        .header {
            text-align: center;
            margin-bottom: 40px;
        }
        .header .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Poppins', sans-serif;
            font-size: 2.8rem;
            font-weight: 700;
            letter-spacing: -.03em;
            color: #fff;
            text-shadow: 0 2px 4px rgba(170, 108, 255, 0.3);
        }
        .header .logo svg {
            width: 40px;
            height: 40px;
            margin-right: 10px;
            fill: url(#mic-grad);
        }
        .header .beta {
            font-size: 0.8rem;
            vertical-align: super;
            background: linear-gradient(90deg, var(--accent1), var(--accent2));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-left: 5px;
        }
        .header p {
            font-size: 1.3rem;
            opacity: 0.9;
            line-height: 1.5;
            font-weight: 400;
            margin-bottom: 0;
        }
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 28px;
            margin-bottom: 30px;
        }
        .card {
            background: var(--card-bg);
            border-radius: 22px;
            padding: 34px 24px;
            box-shadow: 0 8px 48px 0 rgba(53,12,90,0.21);
            position: relative;
            border: 2px solid transparent;
            overflow: hidden;
        }
        .card::before {
            content: '';
            position: absolute;
            z-index: -1;
            top: -4px; left: -4px; right: -4px; bottom: -4px;
            border-radius: 24px;
            background: linear-gradient(110deg, var(--accent1), var(--accent2));
            opacity: 0.28;
            filter: blur(6px);
        }
        .recorder-section { text-align: center; }
        .record-button {
            width: 110px; height: 110px;
            border-radius: 50%;
            border: none;
            background: var(--button-grad);
            color: #fff;
            font-size: 1.25rem;
            font-weight: 700;
            cursor: pointer;
            margin: 18px 0;
            box-shadow: 0 6px 24px 0 #ad3afb99;
            transition: box-shadow 0.2s, transform 0.18s;
            letter-spacing: 1.2px;
            outline: none;
        }
        .record-button:hover { 
            box-shadow: 0 10px 36px 0 #ff82cfbb;
            transform: scale(1.07);
        }
        .record-button.recording {
            animation: pulseGlow 1.3s infinite;
            background: linear-gradient(90deg, #d726e5, #f9327a 78%);
        }
        @keyframes pulseGlow {
            0% { box-shadow: 0 0 12px #d726e577; }
            60% { box-shadow: 0 0 32px #ff82cfbb; }
            100% { box-shadow: 0 0 12px #d726e577; }
        }
        .timer {
            font-size: 1.3rem;
            margin: 10px 0 12px;
            letter-spacing: 1px;
            color: #f7c1ff;
            font-weight: 700;
        }
        .waveform {
            width: 90%; max-width: 420px; height: 80px;
            margin: 20px auto;
            background: #2d1a58dd;
            border-radius: 14px;
            border: 2px solid #ad3afb33;
            display: flex; align-items: center; justify-content: center;
            overflow: hidden;
        }
        .wave-bar {
            width: 6px;
            background: linear-gradient(to top, #f87af8 50%, #ad3afb 100%, #86f7fa 100%);
            margin: 0 1.5px;
            border-radius: 4px;
            transition: height 0.13s cubic-bezier(0.25,0.1,0.24,1.3), background 0.7s;
        }
        .analysis-section h3, .tips-section h3, .exercises-section h3, .progress-section h3 {
            font-size: 1.45rem;
            margin-bottom: 16px;
            letter-spacing: -.02em;
            font-weight: 700;
        }
        .metric {
            background: #240148d9;
            padding: 12px 16px 10px;
            border-radius: 12px;
            margin-bottom: 13px;
            border-left: 4px solid #ad3afb;
            margin-top: 6px;
        }
        .metric-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .metric-name {
            font-weight: bold;
            font-size: 1.06rem;
            color: #fff;
        }
        .metric-score {
            font-weight: 700;
            font-size: 0.95rem;
            padding: 4px 12px;
            border-radius: 20px;
            color: #fff;
            background: var(--metric-grad);
        }
        .score-excellent { background: linear-gradient(90deg, #4dfbda, #86f7fa 90%);}
        .score-good     { background: linear-gradient(90deg, #fff176 0, #f7876d 90%);}
        .score-needs-work { background: linear-gradient(90deg, #e26081 5%, #f72686 90%);}
        .metric-bar {
            width: 100%; height: 8px; background: #3a1976;
            border-radius: 5px; overflow: hidden; margin-top: 2px;
        }
        .metric-fill {
            height: 100%; background: var(--metric-grad);
            border-radius: 5px; transition: width 0.5s;
        }
        .tips-section { grid-column: 1 / -1; }
        .tips-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(265px, 1fr));
            gap: 18px;
            margin: 12px 0 0;
        }
        .tip-card {
            background: linear-gradient(135deg, #865dff 0%, #fa8bff 100%);
            color: #fff;
            padding: 18px;
            border-radius: 12px;
            box-shadow: 0 3px 18px 0 #fa8bff1a;
            font-size: 1rem;
            transition: transform .18s;
        }
        .tip-card:hover { transform: translateY(-4px) scale(1.02);}
        .tip-card h4 { margin-bottom: 7px; font-size: 1.08rem;}
        .exercises-section { grid-column: 1 / -1; margin-top: 22px;}
        .exercise-tabs {
            display: flex;
            gap: 7px;
            margin-bottom: 14px;
            flex-wrap: wrap;
        }
        .tab-button {
            padding: 9px 16px;
            border: none;
            background: #3b196c;
            border-radius: 18px;
            color: #fff;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.98rem;
            transition: all 0.21s;
            letter-spacing: .8px;
        }
        .tab-button.active, .tab-button:focus {
            background: var(--button-grad);
            color: #fff;
            outline: none;
        }
        .exercise-content {
            background: #2d1860e6;
            padding: 19px;
            border-radius: 12px;
            font-size: 1.05rem;
            line-height: 1.6;
        }
        .progress-section { grid-column: 1 / -1; margin-top: 20px;}
        .progress-chart {
            width: 100%; height: 158px;
            background: #321a52aa;
            border-radius: 9px;
            margin-top: 18px;
            display: flex;
            align-items: flex-end;
            justify-content: space-around;
            padding: 18px 9px 8px 9px;
        }
        .progress-bar {
            width: 23px;
            background: var(--metric-grad);
            border-radius: 4.5px 4.5px 0 0;
            margin: 0 4px;
            transition: height .47s;
        }
        .hidden{ display: none; }
        .status-message {
            text-align: center;
            margin: 17px 0 0;
            padding: 13px;
            border-radius: 8px;
            font-weight: 500;
            background: #291548cc;
        }
        .status-info { color: #82e9ff;}
        .status-success { color: #69ffda;}
        .status-error { color: #ff94eb;}
        /* Auth Modals */
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0; top: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.6);
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: var(--card-bg);
            padding: 24px;
            border-radius: 16px;
            width: 320px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        .modal-content h3 { margin-bottom: 16px; }
        .modal-content input {
            width: 100%;
            padding: 10px;
            margin-bottom: 12px;
            border-radius: 8px;
            border: 1px solid var(--accent1);
            background: #3b196c;
            color: #fff;
        }
        .modal-content button {
            width: 100%;
            padding: 12px;
            background: var(--button-grad);
            border: none;
            border-radius: 8px;
            color: #fff;
            font-weight: 700;
            cursor: pointer;
            margin-top: 8px;
        }
        .modal-content .error { color: #ff94eb; margin-top: 8px; font-size: 0.9rem; }
        .auth-message {
            text-align: center;
            padding: 20px;
            background: #2d1860e6;
            border-radius: 12px;
            margin-top: 18px;
        }
        .auth-button {
            padding: 10px 20px;
            background: var(--button-grad);
            border: none;
            border-radius: 20px;
            color: #fff;
            font-weight: 600;
            cursor: pointer;
            margin: 10px 5px 0;
        }
        .coming-soon {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-top: 10px;
        }
        .logout-button {
            padding: 8px 16px;
            background: #e26081;
            border: none;
            border-radius: 20px;
            color: #fff;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
            float: right;
        }
        /* NEW: Playback controls and pitch meter styles */
        .playback-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
        }
        .playback-button {
            padding: 8px 16px;
            background: var(--bg-mid);
            border: none;
            border-radius: 20px;
            color: white;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .playback-button:hover {
            transform: scale(1.05);
            background: var(--bg-light);
        }
        .pitch-meter {
            width: 100%;
            height: 10px;
            background: #2d1a58;
            border-radius: 5px;
            margin-top: 10px;
            overflow: hidden;
        }
        .pitch-fill {
            height: 100%;
            background: linear-gradient(90deg, #4dfbda, #86f7fa);
            width: 0%;
            transition: width 0.3s;
        }
        .pitch-label {
            font-size: 0.8rem;
            margin-top: 5px;
            text-align: center;
            color: #f7c1ff;
        }
        /* NEW: Live feedback indicator */
        .live-feedback {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            background: #555;
            transition: background 0.3s;
        }
        .live-feedback.active {
            background: #4dfbda;
            box-shadow: 0 0 10px #4dfbda;
        }
        /* NEW: Noise level indicator */
        .noise-level {
            width: 100%;
            height: 6px;
            background: #2d1a58;
            border-radius: 3px;
            margin-top: 5px;
            position: relative;
        }
        .noise-level-fill {
            height: 100%;
            background: linear-gradient(90deg, #4dfbda, #f7876d);
            border-radius: 3px;
            width: 0%;
        }
        .noise-level-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.7rem;
            color: #f7c1ff;
            margin-top: 3px;
        }

        /* Footer */
        footer {
            text-align: center;
            padding: 20px;
            font-size: 0.9rem;
            opacity: 0.8;
            position: relative;
            z-index: 1;
        }
        footer a {
            color: var(--accent4);
            text-decoration: underline;
            cursor: pointer;
        }
        
        @media (max-width: 900px) {
            .main-content { grid-template-columns: 1fr; }
        }
        @media (max-width: 480px) {
            .container { padding: 6px; }
            .header .logo { font-size: 1.5rem; }
            .header .logo svg { width: 30px; height: 30px; }
            .card { padding: 13px 6px;}
            .modal-content { width: 90%; }
            /* NEW: Mobile adjustments for new elements */
            .playback-controls {
                flex-direction: column;
                align-items: center;
            }
        }
    </style>
</head>
<body>
    <!-- animated svg waves background -->
    <div class="waves-bg" aria-hidden="true">
        <svg width="100%" height="100%" viewBox="0 0 1440 700" fill="none" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="none" style="position:absolute; left:0;top:0; z-index:0;">
            <defs>
                <linearGradient id="waveGrad1" x1="0" y1="0" x2="0" y2="1">
                    <stop offset="0%" stop-color="#ae72ff" />
                    <stop offset="100%" stop-color="#fd70f8" />
                </linearGradient>
                <linearGradient id="waveGrad2" x1="0" y1="0" x2="1" y2="1">
                    <stop offset="0%" stop-color="#40159f" />
                    <stop offset="100%" stop-color="#fd70f8" />
                </linearGradient>
            </defs>
            <path id="wave1"
                fill="url(#waveGrad1)" opacity="0.64">
                <animate attributeName="d" dur="8s" repeatCount="indefinite"
                values="
                M0,480 Q720,650 1440,480 V700 H0Z;
                M0,520 Q720,600 1440,520 V700 H0Z;
                M0,480 Q720,650 1440,480 V700 H0Z;" />
            </path>
            <path id="wave2"
                fill="url(#waveGrad2)" opacity="0.38">
                <animate attributeName="d" dur="10s" repeatCount="indefinite"
                values="
                M0,580 Q720,450 1440,620 V700 H0Z;
                M0,540 Q720,640 1440,540 V700 H0Z;
                M0,580 Q720,450 1440,620 V700 H0Z;" />
            </path>
        </svg>
    </div>

    <div class="container">
        <div class="header">
            <div class="logo">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <linearGradient id="mic-grad" x1="0" y1="0" x2="1" y2="1">
                            <stop offset="0%" stop-color="#AA6CFF" />
                            <stop offset="100%" stop-color="#FC67FA" />
                        </linearGradient>
                    </defs>
                    <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.91-3c-.49 0-.9.36-.98.85C16.52 14.2 14.47 16 12 16s-4.52-1.8-4.93-4.15c-.08-.49-.49-.85-.98-.85-.61 0-1.09.54-1 1.14.49 3 3.17 5.42 6.91 5.42.59 0 1.15-.08 1.67-.23V21h-3c-.55 0-1 .45-1 1s.45 1 1 1h8c.55 0 1-.45 1-1s-.45-1-1-1h-3v-3.77c.52.15 1.08.23 1.67.23 3.74 0 6.42-2.42 6.91-5.42.09-.6-.39-1.14-1-1.14z" />
                </svg>
                Am I Audible
                <span class="beta">Beta</span>
            </div>
            <p>
                Discover your <b>voice superpowers</b>! <br>
                Join the next-gen of confident communicators.<br>
                <span style="color:#FF6FD8; font-weight:600;">Record. Analyze. Shine.</span>
            </p>
        </div>
        <div class="main-content">
            <div class="card recorder-section">
                <h3>🎤 Try It: Record Your Voice</h3>
                <div class="live-feedback"></div>
                <button class="record-button" id="recordBtn">START</button>
                <div class="timer" id="timer">00:00</div>
                <div class="waveform" id="waveform">
                    <span style="color: #FFD6FB;">Tap START and rock your intro! 🚀</span>
                </div>
                <div class="pitch-meter">
                    <div class="pitch-fill" id="pitchFill"></div>
                    <div class="pitch-label" id="pitchLabel">Pitch Stability: --</div>
                </div>
                <div class="noise-level">
                    <div class="noise-level-fill" id="noiseLevelFill"></div>
                </div>
                <div class="noise-level-labels">
                    <span>Low</span>
                    <span>Noise Level</span>
                    <span>High</span>
                </div>
                <div class="status-message status-info" id="statusMessage">
                    Hit record and drop a 30–60 second voice sample!
                </div>
                <div class="playback-controls hidden" id="playbackControls">
                    <button class="playback-button" id="playButton">▶️ Play</button>
                    <button class="playback-button" id="downloadButton">⬇️ Download</button>
                </div>
            </div>

            <div class="card analysis-section">
                <h3>🔎 Your Voice Analysis</h3>
                <div id="analysisResults" class="hidden">
                    <div class="metric"><div class="metric-header">
                        <span class="metric-name">Clarity</span>
                        <span class="metric-score" id="clarityScore">-</span>
                    </div>
                    <div class="metric-bar"><div class="metric-fill" id="clarityBar" style="width: 0%"></div></div>
                    </div>
                    <div class="metric"><div class="metric-header">
                        <span class="metric-name">Pace</span>
                        <span class="metric-score" id="paceScore">-</span>
                    </div>
                    <div class="metric-bar"><div class="metric-fill" id="paceBar" style="width: 0%"></div></div>
                    </div>
                    <div class="metric"><div class="metric-header">
                        <span class="metric-name">Volume</span>
                        <span class="metric-score" id="volumeScore">-</span>
                    </div>
                    <div class="metric-bar"><div class="metric-fill" id="volumeBar" style="width: 0%"></div></div>
                    </div>
                    <div class="metric"><div class="metric-header">
                        <span class="metric-name">Articulation</span>
                        <span class="metric-score" id="articulationScore">-</span>
                    </div>
                    <div class="metric-bar"><div class="metric-fill" id="articulationBar" style="width: 0%"></div></div>
                    </div>
                    <div class="metric"><div class="metric-header">
                        <span class="metric-name">Pitch Stability</span>
                        <span class="metric-score" id="pitchStabilityScore">-</span>
                    </div>
                    <div class="metric-bar"><div class="metric-fill" id="pitchStabilityBar" style="width: 0%"></div></div>
                    </div>
                </div>
                <div id="noAnalysis">
                    Speak your mind to unlock your stats! 🚦
                </div>
            </div>

            <div class="card tips-section">
                <h3>🔮 Pro Tips, Just For You</h3>
                <div class="tips-grid" id="tipsGrid">
                    <div class="tip-card">
                        <h4>🔊 Volume Wins</h4>
                        <p>Keep your sound leveled up. Try talking over some music to boost your vocal clarity.</p>
                    </div>
                    <div class="tip-card">
                        <h4>⏱️ Slay The Pace</h4>
                        <p>Aim for a rhythm of 150–160 words per minute. Pauses are powerful—let them do the talking!</p>
                    </div>
                    <div class="tip-card">
                        <h4>🦸 Crisp Articulation</h4>
                        <p>Hit those consonants and exaggerate your words. Tongue twisters = best warmup hack.</p>
                    </div>
                </div>
            </div>

            <div class="card exercises-section">
                <h3>💪 Level Up Your Voice</h3>
                <div class="exercise-tabs">
                    <button class="tab-button active" data-exercise="breathing">Breathing</button>
                    <button class="tab-button" data-exercise="articulation">Articulation</button>
                    <button class="tab-button" data-exercise="pace">Pace</button>
                    <button class="tab-button" data-exercise="volume">Volume</button>
                </div>
                <div class="exercise-content" id="exerciseContent">
                    <h4>🌬️ Breathing Mastery</h4>
                    <p><strong>Belly Breaths:</strong> Hand on belly, hand on chest. Move only your belly. Feel the calm!</p>
                    <p><strong>4-7-8 Technique:</strong> Breathe in for 4, hold for 7, out for 8. Four rounds = zen unlocked.</p>
                    <p><strong>Lip Trills:</strong> Say "brrrrr" as you exhale for instant tension release.</p>
                </div>
            </div>

            <div class="card progress-section">
                <h3>📈 Your Streak: 7-Day Progress</h3>
                <p id="progressMessage">Pumped for improvement? See your evolution below:</p>
                <div class="progress-chart" id="progressChart"></div>
                <!-- Google Login Section ONLY -->
                <div id="authSection" class="auth-message hidden">
                    <p>Sign in with Google to track your voice journey! 🚀</p>
                    <button class="auth-button" id="googleLoginBtn">Sign in with Google</button>
                    <p class="coming-soon">Coming Soon: Save sessions and recordings to your account!</p>
                </div>
                <button id="logoutButton" class="logout-button hidden" onclick="logout()">Logout</button>
            </div>
        </div>
    </div>

    <!-- Disclaimer Modal -->
    <div id="disclaimerModal" class="modal">
        <div class="modal-content" style="width: 400px;">
            <h3>Disclaimer</h3>
            <p>This service is currently under development and in beta phase. The voice analysis results may not be fully accurate or reliable. We are continuously improving the tool to provide better insights.</p>
            <p>This project is open source and hosted on GitHub. © ArchiSHOTS. Licensed under the MIT License—feel free to use, modify, and distribute as per the license terms (see LICENSE file for details).</p>
            <button onclick="document.getElementById('disclaimerModal').style.display='none'">Close</button>
        </div>
    </div>

    <!-- Footer -->
    <footer>
        © ArchiSHOTS | <a onclick="document.getElementById('disclaimerModal').style.display='flex'">Disclaimer</a>
    </footer>

<script>
    // Initialize Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyBpNh5t5gUprmzQOAwcXTSCDXUDSyclBi8",
        authDomain: "voiceanalyzer-1.firebaseapp.com",
        projectId: "voiceanalyzer-1",
        storageBucket: "voiceanalyzer-1.firebasestorage.app",
        messagingSenderId: "228287966150",
        appId: "1:228287966150:web:50b0225574d0a13a3960c7",
        measurementId: "G-RGTJVZK87Z"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();

    // ONLY Google Auth will be used!
    async function googleLogin() {
        const provider = new firebase.auth.GoogleAuthProvider();
        try {
            await auth.signInWithPopup(provider);
        } catch (error) {
            alert(error.message);
        }
    }

    function logout() {
        auth.signOut()
            .then(() => {
                if (app) {
                    app.currentUser = null;
                    app.updateProgressUI();
                    app.statusMessage.textContent = 'Logged out successfully! Log in to track progress.';
                    app.statusMessage.className = 'status-message status-info';
                }
            })
            .catch((error) => {
                alert('Logout error: ' + error.message);
            });
    }

    // ====== App Logic Class below (unchanged except login/register is removed) ======
    class VoiceAnalyzer {
        constructor() {
            this.mediaRecorder = null;
            this.audioContext = null;
            this.analyser = null;
            this.microphone = null;
            this.isRecording = false;
            this.startTime = null;
            this.recordingData = [];
            this.audioChunks = [];
            this.timer = null;
            this.currentExercise = 'breathing';
            this.currentUser = null;
            this.lastRecording = null;
            this.pitchData = [];
            this.noiseLevel = 0;
            this.scriptProcessor = null;

            this.initializeElements();
            this.setupEventListeners();
            this.setupAuthStateListener();
        }

        initializeElements() {
            this.recordBtn = document.getElementById('recordBtn');
            this.timerDisplay = document.getElementById('timer');
            this.waveform = document.getElementById('waveform');
            this.statusMessage = document.getElementById('statusMessage');
            this.analysisResults = document.getElementById('analysisResults');
            this.noAnalysis = document.getElementById('noAnalysis');
            this.progressChart = document.getElementById('progressChart');
            this.progressMessage = document.getElementById('progressMessage');
            this.authSection = document.getElementById('authSection');
            this.logoutButton = document.getElementById('logoutButton');
            this.playButton = document.getElementById('playButton');
            this.downloadButton = document.getElementById('downloadButton');
            this.playbackControls = document.getElementById('playbackControls');
            this.pitchFill = document.getElementById('pitchFill');
            this.pitchLabel = document.getElementById('pitchLabel');
            this.pitchScoreElement = document.getElementById('pitchStabilityScore');
            this.pitchBar = document.getElementById('pitchStabilityBar');
            this.noiseLevelFill = document.getElementById('noiseLevelFill');
            this.liveFeedback = document.querySelector('.live-feedback');
        }

        setupAuthStateListener() {
            auth.onAuthStateChanged((user) => {
                if (user) {
                    this.currentUser = user.email;
                    this.updateProgressUI();
                    this.statusMessage.textContent = `Welcome back, ${this.currentUser}! Let's check your progress.`;
                    this.statusMessage.className = 'status-message status-success';
                } else {
                    this.currentUser = null;
                    this.updateProgressUI();
                }
            });
        }

        setupEventListeners() {
            this.recordBtn.addEventListener('click', () => this.toggleRecording());

            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.addEventListener('click', (e) => this.switchExercise(e.target.dataset.exercise));
            });

            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) modal.style.display = 'none';
                });
            });

            this.playButton.addEventListener('click', () => this.playLastRecording());
            this.downloadButton.addEventListener('click', () => this.downloadRecording());

            // Google Login Button
            document.getElementById('googleLoginBtn').addEventListener('click', googleLogin);
        }

        updateProgressUI() {
            if (this.currentUser) {
                this.authSection.classList.add('hidden');
                this.logoutButton.classList.remove('hidden');
                this.progressMessage.textContent = `Hey ${this.currentUser}, here's your 7-day streak:`;
                this.loadProgress();
                this.generateProgressChart();
            } else {
                this.progressChart.innerHTML = '';
                this.progressMessage.textContent = '';
                this.authSection.classList.remove('hidden');
                this.logoutButton.classList.add('hidden');
            }
        }

        async toggleRecording() {
            if (!this.isRecording) {
                await this.startRecording();
            } else {
                this.stopRecording();
            }
        }

        async startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                this.setupAudioAnalysis(stream);
                this.setupMediaRecorder(stream);

                this.isRecording = true;
                this.startTime = Date.now();
                this.audioChunks = [];
                this.recordingData = [];
                this.pitchData = [];
                this.noiseLevel = 0;

                this.recordBtn.textContent = 'STOP';
                this.recordBtn.classList.add('recording');
                this.statusMessage.textContent = 'Recording... Speak clearly for 30-60 seconds';
                this.statusMessage.className = 'status-message status-success';
                this.playbackControls.classList.add('hidden');

                this.mediaRecorder.start(100);
                this.startTimer();
                this.startWaveformVisualization();
                this.startPitchAnalysis();

            } catch (error) {
                this.showError('Microphone access denied. Please allow microphone permissions.');
            }
        }

        setupAudioAnalysis(stream) {
            this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
            this.analyser = this.audioContext.createAnalyser();
            this.microphone = this.audioContext.createMediaStreamSource(stream);

            this.analyser.fftSize = 256;
            this.microphone.connect(this.analyser);

            this.scriptProcessor = this.audioContext.createScriptProcessor(4096, 1, 1);
            this.scriptProcessor.connect(this.audioContext.destination);
            this.microphone.connect(this.scriptProcessor);
        }

        setupMediaRecorder(stream) {
            this.mediaRecorder = new MediaRecorder(stream);

            this.mediaRecorder.ondataavailable = (event) => {
                if (event.data.size > 0) {
                    this.audioChunks.push(event.data);
                    this.collectAudioData();
                }
            };

            this.mediaRecorder.onstop = () => {
                this.processRecording();
            };
        }

        startPitchAnalysis() {
            this.scriptProcessor.onaudioprocess = (event) => {
                if (!this.isRecording) return;

                const inputBuffer = event.inputBuffer;
                const inputData = inputBuffer.getChannelData(0);

                const pitch = this.detectPitch(inputData);
                if (pitch > 0) {
                    this.pitchData.push(pitch);
                    this.updateLivePitchFeedback(pitch);
                }

                const rms = this.calculateRMS(inputData);
                if (rms < 0.01) {
                    this.noiseLevel = rms * 1000;
                    this.updateNoiseLevelDisplay();
                }

                this.updateLiveFeedback(rms);
            };
        }

        detectPitch(inputData) {
            const sampleRate = this.audioContext.sampleRate;
            const bufferSize = inputData.length;

            let zeroCrossing = 0;
            while (zeroCrossing < bufferSize - 1 &&
                  inputData[zeroCrossing] * inputData[zeroCrossing + 1] > 0) {
                zeroCrossing++;
            }

            if (zeroCrossing >= bufferSize - 1) return 0;

            const maxOffset = Math.floor(sampleRate / 60);
            const minOffset = Math.floor(sampleRate / 300);

            let bestOffset = 0;
            let bestCorrelation = 0;

            for (let offset = minOffset; offset <= maxOffset; offset++) {
                let correlation = 0;

                for (let i = 0; i < bufferSize - offset; i++) {
                    correlation += Math.abs(inputData[i] * inputData[i + offset]);
                }

                if (correlation > bestCorrelation) {
                    bestCorrelation = correlation;
                    bestOffset = offset;
                }
            }

            if (bestOffset === 0) return 0;
            return sampleRate / bestOffset;
        }

        calculateRMS(inputData) {
            let sum = 0;
            for (let i = 0; i < inputData.length; i++) {
                sum += inputData[i] * inputData[i];
            }
            return Math.sqrt(sum / inputData.length);
        }

        updateLivePitchFeedback(currentPitch) {
            if (!this.pitchData.length) return;

            const avgPitch = this.pitchData.reduce((sum, p) => sum + p, 0) / this.pitchData.length;
            const variance = this.pitchData.reduce((sum, p) => sum + Math.pow(p - avgPitch, 2), 0) / this.pitchData.length;

            const stability = Math.max(0, 100 - (Math.sqrt(variance) / 2));
            this.pitchFill.style.width = `${stability}%`;

            if (avgPitch < 165) {
                this.pitchLabel.textContent = `Pitch Stability: Low (${Math.round(stability)}%)`;
            } else if (avgPitch < 255) {
                this.pitchLabel.textContent = `Pitch Stability: Medium (${Math.round(stability)}%)`;
            } else {
                this.pitchLabel.textContent = `Pitch Stability: High (${Math.round(stability)}%)`;
            }
        }

        updateNoiseLevelDisplay() {
            const noisePercentage = Math.min(100, Math.max(0, this.noiseLevel * 100));
            this.noiseLevelFill.style.width = `${noisePercentage}%`;

            if (noisePercentage < 30) {
                this.noiseLevelFill.style.background = '#4dfbda';
            } else if (noisePercentage < 70) {
                this.noiseLevelFill.style.background = '#fff176';
            } else {
                this.noiseLevelFill.style.background = '#f7876d';
            }
        }

        updateLiveFeedback(rms) {
            if (rms < 0.01) {
                this.liveFeedback.style.background = '#555';
            } else if (rms < 0.05) {
                this.liveFeedback.style.background = '#f7876d';
                this.liveFeedback.classList.remove('active');
            } else {
                this.liveFeedback.style.background = '#4dfbda';
                this.liveFeedback.classList.add('active');
            }
        }

        collectAudioData() {
            const bufferLength = this.analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);
            this.analyser.getByteFrequencyData(dataArray);

            const volume = dataArray.reduce((sum, value) => sum + value) / bufferLength;
            const timestamp = Date.now() - this.startTime;

            this.recordingData.push({
                timestamp,
                volume,
                frequencies: Array.from(dataArray)
            });
        }

        startTimer() {
            let seconds = 0;
            this.timer = setInterval(() => {
                seconds++;
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                this.timerDisplay.textContent = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;

                if (seconds >= 60) {
                    this.stopRecording();
                }
            }, 1000);
        }

        startWaveformVisualization() {
            this.waveform.innerHTML = '';
            const bars = [];

            for (let i = 0; i < 50; i++) {
                const bar = document.createElement('div');
                bar.className = 'wave-bar';
                bar.style.height = '5px';
                this.waveform.appendChild(bar);
                bars.push(bar);
            }

            const animate = () => {
                if (!this.isRecording) return;

                const bufferLength = this.analyser.frequencyBinCount;
                const dataArray = new Uint8Array(bufferLength);
                this.analyser.getByteFrequencyData(dataArray);

                bars.forEach((bar, i) => {
                    const value = dataArray[i * 2] || 0;
                    const height = Math.max(5, (value / 255) * 80);
                    bar.style.height = height + 'px';
                });

                requestAnimationFrame(animate);
            };

            animate();
        }

        stopRecording() {
            if (!this.isRecording) return;

            this.isRecording = false;
            this.mediaRecorder.stop();
            clearInterval(this.timer);

            if (this.microphone && this.microphone.mediaStream) {
                this.microphone.mediaStream.getTracks().forEach(track => track.stop());
            }

            this.recordBtn.textContent = 'START';
            this.recordBtn.classList.remove('recording');
            this.statusMessage.textContent = 'Processing your recording...';
            this.statusMessage.className = 'status-message status-info';
        }

        processRecording() {
            const audioBlob = new Blob(this.audioChunks, { type: 'audio/wav' });
            this.lastRecording = audioBlob;
            const duration = (Date.now() - this.startTime) / 1000;

            if (duration < 5) {
                this.showError('Recording too short. Please record for at least 5 seconds.');
                return;
            }

            this.analyzeVoice(duration);
            if (this.currentUser) this.saveProgress();
            this.updateProgressUI();

            this.playbackControls.classList.remove('hidden');
        }

        analyzeVoice(duration) {
            const volumes = this.recordingData.map(d => d.volume);
            const avgVolume = volumes.reduce((sum, v) => sum + v, 0) / volumes.length;
            const volumeVariance = this.calculateVariance(volumes);

            const noiseScore = Math.max(0, 100 - (this.noiseLevel * 10));

            if (avgVolume < 10) {
                this.showError('No voice detected! Please speak during the recording for accurate analysis.');
                return;
            }

            const volumeThreshold = avgVolume * 1.2;
            const spikes = volumes.filter(v => v > volumeThreshold).length;
            const estimatedWords = Math.max(1, Math.floor(spikes / 3));
            const wordsPerMinute = Math.round((estimatedWords / duration) * 60);

            const allFrequencies = this.recordingData.map(d => d.frequencies).flat();
            const highFreqRatio = this.calculateHighFrequencyRatio(allFrequencies);

            const pitchStability = this.calculatePitchStability();

            this.scores = {
                clarity: this.calculateClarityScore(avgVolume, volumeVariance, highFreqRatio),
                pace: this.calculatePaceScore(wordsPerMinute),
                volume: this.calculateVolumeScore(avgVolume),
                articulation: this.calculateArticulationScore(highFreqRatio, volumeVariance),
                pitchStability: this.calculatePitchStability(),
                noiseLevel: noiseScore
            };

            this.generatePersonalizedTips();
            this.showAnalysisResults();
        }

        calculatePitchStability() {
            if (!this.pitchData.length) return 50;

            const avgPitch = this.pitchData.reduce((sum, p) => sum + p, 0) / this.pitchData.length;
            const variance = this.pitchData.reduce((sum, p) => sum + Math.pow(p - avgPitch, 2), 0) / this.pitchData.length;
            const stdDev = Math.sqrt(variance);

            let score = 100 - (stdDev * 2);
            return Math.max(0, Math.min(100, Math.round(score)));
        }

        calculateVariance(values) {
            const mean = values.reduce((sum, v) => sum + v) / values.length;
            const squaredDiffs = values.map(v => Math.pow(v - mean, 2));
            return squaredDiffs.reduce((sum, sq) => sum + sq) / squaredDiffs.length;
        }

        calculateHighFrequencyRatio(frequencies) {
            const midPoint = frequencies.length / 2;
            const lowFreq = frequencies.slice(0, midPoint).reduce((sum, f) => sum + f);
            const highFreq = frequencies.slice(midPoint).reduce((sum, f) => sum + f);
            return highFreq / (lowFreq + highFreq + 1);
        }

        calculateClarityScore(avgVolume, volumeVariance, highFreqRatio) {
            let score = 50;

            if (volumeVariance < 100) score += 20;
            else if (volumeVariance < 200) score += 10;

            if (highFreqRatio > 0.3 && highFreqRatio < 0.7) score += 20;
            else if (highFreqRatio > 0.2 && highFreqRatio < 0.8) score += 10;

            if (avgVolume > 30 && avgVolume < 100) score += 10;

            return Math.min(100, Math.max(0, score));
        }

        calculatePaceScore(wpm) {
            let score = 50;

            if (wpm >= 140 && wpm <= 170) score = 100;
            else if (wpm >= 120 && wpm <= 190) score = 80;
            else if (wpm >= 100 && wpm <= 210) score = 60;
            else if (wpm < 100) score = Math.max(20, 60 - (100 - wpm));
            else score = Math.max(20, 60 - (wpm - 210) / 2);

            return Math.round(score);
        }

        calculateVolumeScore(avgVolume) {
            let score = 50;

            if (avgVolume >= 40 && avgVolume <= 80) score = 100;
            else if (avgVolume >= 30 && avgVolume <= 90) score = 80;
            else if (avgVolume >= 20 && avgVolume <= 100) score = 60;
            else if (avgVolume < 20) score = 30;
            else score = Math.max(30, 90 - avgVolume);

            return Math.round(score);
        }

        calculateArticulationScore(highFreqRatio, volumeVariance) {
            let score = 50;

            if (highFreqRatio > 0.4) score += 25;
            else if (highFreqRatio > 0.3) score += 15;
            else if (highFreqRatio > 0.2) score += 5;

            if (volumeVariance < 150) score += 25;
            else if (volumeVariance < 250) score += 15;
            else if (volumeVariance < 350) score += 5;

            return Math.min(100, Math.max(0, score));
        }

        showAnalysisResults() {

            console.log("Current scores:", this.scores); 

            this.noAnalysis.classList.add('hidden');
            this.analysisResults.classList.remove('hidden');

            Object.keys(this.scores).forEach(metric => {
                if (metric === 'noiseLevel') return;

                const score = this.scores[metric];
                const scoreElement = document.getElementById(`${metric}Score`);
                const barElement = document.getElementById(`${metric}Bar`);

                console.log(`Checking metric: ${metric}`, {  // Debug log
                    elementExists: !!scoreElement,
                    score: this.scores[metric]
                });

                if (!scoreElement || !barElement) {
                    console.warn(`Missing elements for metric: ${metric}`); // Debug log
                    return;
                }

                let level, className;
                if (score >= 80) { level = 'Excellent'; className = 'score-excellent'; }
                else if (score >= 60) { level = 'Good'; className = 'score-good'; }
                else { level = 'Needs Work'; className = 'score-needs-work'; }

                scoreElement.textContent = level;
                scoreElement.className = `metric-score ${className}`;

                setTimeout(() => {
                    barElement.style.width = score + '%';
                }, 100);
            });

            let noiseFeedback = '';
            if (this.scores.noiseLevel < 60) {
                noiseFeedback = ' High background noise detected - try a quieter environment.';
            }

            this.statusMessage.textContent = 'Analysis complete! See your results above.' + noiseFeedback;
            this.statusMessage.className = 'status-message status-success';
        }

        generatePersonalizedTips() {
            const tips = [];

            if (this.scores.volume < 70) {
                tips.push({
                    title: '🔊 Improve Volume Control',
                    content: 'Practice speaking with consistent volume. Try reading aloud while recording yourself to monitor your volume levels.'
                });
            }

            if (this.scores.pace < 70) {
                tips.push({
                    title: '⏱️ Work on Your Pace',
                    content: 'Practice reading at 150-160 words per minute. Use a metronome or timer to maintain steady rhythm.'
                });
            }

            if (this.scores.clarity < 70) {
                tips.push({
                    title: '💎 Enhance Clarity',
                    content: 'Focus on opening your mouth wider and enunciating consonants clearly. Practice tongue twisters daily.'
                });
            }

            if (this.scores.articulation < 70) {
                tips.push({
                    title: '🎯 Better Articulation',
                    content: 'Work on mouth positioning and tongue placement. Practice vowel sounds and consonant combinations.'
                });
            }

            if (this.scores.pitchStability < 70) {
                tips.push({
                    title: '🎵 Pitch Consistency',
                    content: 'Practice sustaining notes at a consistent pitch. Try humming a single note for 10 seconds.'
                });
            }

            const tipsGrid = document.getElementById('tipsGrid');
            if (tips.length > 0) {
                tipsGrid.innerHTML = tips.map(tip => `
                    <div class="tip-card">
                        <h4>${tip.title}</h4>
                        <p>${tip.content}</p>
                    </div>
                `).join('');
            } else {
                tipsGrid.innerHTML = '<p style="grid-column: 1 / -1; text-align: center;">Your voice is on fire! Keep it up 🔥</p>';
            }
        }

        playLastRecording() {
            if (!this.lastRecording) return;

            const audioURL = URL.createObjectURL(this.lastRecording);
            const audio = new Audio(audioURL);
            audio.play();

            this.playButton.textContent = '⏸️ Pause';
            this.playButton.onclick = () => {
                audio.pause();
                this.playButton.textContent = '▶️ Play';
                this.playButton.onclick = () => this.playLastRecording();
            };

            audio.onended = () => {
                this.playButton.textContent = '▶️ Play';
                this.playButton.onclick = () => this.playLastRecording();
            };
        }

        downloadRecording() {
            if (!this.lastRecording) return;

            const date = new Date().toISOString().replace(/[:.]/g, '-');
            const url = URL.createObjectURL(this.lastRecording);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = `voice-recording-${date}.wav`;
            document.body.appendChild(a);
            a.click();
            setTimeout(() => {
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            }, 100);
        }

        switchExercise(exercise) {
            this.currentExercise = exercise;

            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.exercise === exercise);
            });

            const exercises = {
                breathing: {
                    title: '🌬️ Breathing Mastery',
                    content: `
                        <p><strong>Belly Breaths:</strong> Hand on belly, hand on chest. Move only your belly. Feel the calm!</p>
                        <p><strong>4-7-8 Technique:</strong> Breathe in for 4, hold for 7, out for 8. Four rounds = zen unlocked.</p>
                        <p><strong>Lip Trills:</strong> Say "brrrrr" as you exhale for instant tension release.</p>
                    `
                },
                articulation: {
                    title: '🗣️ Articulation Exercises',
                    content: `
                        <p><strong>Tongue Twisters:</strong> "Red leather, yellow leather" - Repeat 5 times quickly.</p>
                        <p><strong>Consonant Precision:</strong> "P-B-P-B-P-B" - Alternate between sounds clearly.</p>
                        <p><strong>Vowel Clarity:</strong> "A-E-I-O-U" - Exaggerate each vowel sound for 2 seconds each.</p>
                    `
                },
                pace: {
                    title: '⏰ Pace Control Exercises',
                    content: `
                        <p><strong>Metronome Reading:</strong> Read aloud with a metronome set to 150 BPM, one word per beat.</p>
                        <p><strong>Punctuation Pauses:</strong> Practice pausing for 1 second at commas, 2 seconds at periods.</p>
                        <p><strong>Speed Variations:</strong> Read the same paragraph slow, normal, then fast to find your optimal pace.</p>
                    `
                },
                volume: {
                    title: '📢 Volume Control Exercises',
                    content: `
                        <p><strong>Volume Scales:</strong> Count 1-10, increasing volume with each number, then back down.</p>
                        <p><strong>Consistent Projection:</strong> Practice speaking at your target volume for 2 minutes straight.</p>
                        <p><strong>Room Adaptation:</strong> Practice adjusting your volume for different room sizes and background noise levels.</p>
                    `
                }
            };

            const content = exercises[exercise];
            document.getElementById('exerciseContent').innerHTML = `
                <h4>${content.title}</h4>
                ${content.content}
            `;
        }

        saveProgress() {
            if (!this.currentUser) return;

            const today = new Date().toISOString().split('T')[0];
            const userProgressKey = `voiceProgress_${this.currentUser}`;
            const progress = JSON.parse(localStorage.getItem(userProgressKey) || '{}');

            progress[today] = {
                scores: this.scores,
                timestamp: Date.now()
            };

            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

            Object.keys(progress).forEach(date => {
                if (new Date(date) < thirtyDaysAgo) {
                    delete progress[date];
                }
            });

            localStorage.setItem(userProgressKey, JSON.stringify(progress));
            this.generateProgressChart();
        }

        loadProgress() {
            if (!this.currentUser) return {};

            const userProgressKey = `voiceProgress_${this.currentUser}`;
            this.progress = JSON.parse(localStorage.getItem(userProgressKey) || '{}');
            return this.progress;
        }

        generateProgressChart() {
            this.progressChart.innerHTML = '';
            const progress = this.loadProgress();
            const dates = Object.keys(progress).sort().slice(-7);

            if (dates.length === 0) {
                this.progressChart.innerHTML = '<p style="color: #FFD6FB; text-align: center; margin: auto;">Start recording to build your streak! 📈</p>';
                return;
            }

            dates.forEach((date, index) => {
                const session = progress[date];
                const avgScore = Object.values(session.scores).reduce((sum, score) => sum + score, 0) / 5;

                const bar = document.createElement('div');
                bar.className = 'progress-bar';
                bar.style.height = (avgScore * 1.5) + 'px';
                bar.title = `${date}: ${Math.round(avgScore)}% average`;

                setTimeout(() => {
                    bar.style.height = (avgScore * 1.5) + 'px';
                }, index * 100);

                this.progressChart.appendChild(bar);
            });
        }

        showError(message) {
            this.statusMessage.textContent = message;
            this.statusMessage.className = 'status-message status-error';

            this.recordBtn.textContent = 'START';
            this.recordBtn.classList.remove('recording');
            this.isRecording = false;

            if (this.timer) {
                clearInterval(this.timer);
            }

            this.analysisResults.classList.add('hidden');
            this.noAnalysis.classList.remove('hidden');
            this.noAnalysis.textContent = message;
        }
    }

    // Init app
    let app;
    document.addEventListener('DOMContentLoaded', () => {
        app = new VoiceAnalyzer();
    });
</script>
</body>
</html>
